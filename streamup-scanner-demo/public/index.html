<html>
	<head>
		<script src="js/jquery-2.1.1.js"></script>
		<script src="js/SensorAPI.js"></script>
		<script src="js/StreamUp.standalone.js"></script>				
		<script src="js/lodash.min.js"></script>
		<script src="js/postal.js"></script>
		<script src="js/stream-scanner-demo.js"></script>
		<script src="js/jquery.flot.js"></script>		
	</head>
	<body>
    Listing of devices:
    <div id='device_list'></div>
    <script>		
		function getMatches(string, regex, index) {
			index || (index = 1); // default to the first capturing group
			var matches = [];
			var match;
			while (match = regex.exec(string)) {
				matches.push(match[index]);
			}
			return matches;
		}

    	var currentDevices = [];
		var api = new SensorAPI();
		api.loadDriver("js/driver/browserDeviceMotion.js");		

		var announceDevice = function(deviceInfo) {
			postal.publish({
				channel: "meta",
				topic: "device.add",
				data: deviceInfo
			});
		}

		var announceSensor = function(deviceId, sensor) {
			postal.publish({
				channel: "meta",
				topic: deviceId + ".sensor.add",
				data: sensor
			});
		}

		var announceValue = function(deviceId, sensorId, value) {
			postal.publish({
				channel: "meta",
				topic: deviceId + "." + sensorId + ".value.add",
				data: value
			});
		}	

		var refreshDisplay = function() {
			var sensors =[];
			var text = "";
			currentDevices.forEach(function(device) {
					text += "	device '" + device.name + "' " + "(driver: '" + device.driver + "'</br>";
					device.sensors.forEach(function(sensor) {						
						sensors.push({deviceId: device.ID, sensor: sensor});
						text += "		sensor '" + sensor.name + "' </br>";
						text += '<div id="flot-placeholder-' + sensor.ID + '" style="width:300px;height:150px"></div>';												
					})
				})
			$('#device_list').html("<pre>" + text + "</pre></br>");						
			sensors.forEach(function(element) {
				announceSensor(element.deviceId, element.sensor);
			})
		}




		api.onDeviceAdded(function(deviceInfo) {						
			// globally keep track of already known drivers, devices and sensors
			// announce new devices, sensors and values on message bus
			var device = currentDevices.find(function(element) {
							return element.ID === deviceInfo.device.ID;
						});
			if (!device) {			
				device = 	{
								ID: deviceInfo.device.ID,
								name: deviceInfo.device.name,
								description: deviceInfo.device.description,
								driver: deviceInfo.driver,
								sensors: []
							};
				currentDevices.push(device);
				announceDevice(deviceInfo);
			}
			deviceInfo.device.sensors.forEach(function(element) {
				// check if sensor is present
				var sensor = device.sensors.find(function(sensor) {
							 return element.ID === sensor.ID;
				 		 });					
				if (!sensor) {			
					sensor = element;	
					sensor['data'] = [];
					// subscribe to sensor							
					device.sensors.push(element);
					// announce later so that html is already generated for chart
					//announceSensor(device.ID, element);
					sensor.subscribe(function(data) {
						announceValue(device.ID, sensor.ID, data);
					})
				}
			})
			refreshDisplay();						
		});
		
		var getDataForSensor = function(deviceId, sensorId) {
			return currentDevices.find(function(deviceInfo) {
							return deviceInfo.ID == deviceId;
						}).sensors.find(function(sensor) {
							return sensor.ID == sensorId;
						}).data;
		}

		var addToChart =function(plot, deviceId, sensorId) {					
			var data = getDataForSensor(deviceId, sensorId);
			//alert('addToChart data: ' + JSON.stringify(data));
			var plot = $.plot("#flot-placeholder-" + sensorId, [data], {
					series: {
						shadowSize: 0,
						lines: {
					        show: true,
					        lineWidth: 1.2,
					        fill: true
					    }
					},
					yaxis: {
						min: 0,
						max: 100
					},
					xaxis: {
						mode: "time",
						show: false
					}});
			//plot.setData([data]);
		    plot.draw();
		    setTimeout(addToChart.bind(this, plot, deviceId, sensorId), 1000);
		}
		
		var subscriptionAddSensor = postal.subscribe({
			channel: "meta",
			topic: "#.sensor.add",
			callback: function(sensor, envelope) {				
				var deviceId = getMatches(envelope.topic, new RegExp('^(.*)\.sensor\.add$', 'g'), 1);		
				var sensorId = sensor.ID;
				var plot = $.plot("#flot-placeholder-" + sensorId, [[]], {
					series: {
						shadowSize: 0,
						lines: {
					        show: true,
					        lineWidth: 1.2,
					        fill: true
					    }
					},
					yaxis: {
						min: 0,
						max: 100
					},
					xaxis: {
						mode: "time",
						show: false
					}});
				addToChart(plot, deviceId, sensorId);
			}})

		var subscriptionAddValue = postal.subscribe({
			channel: "meta",
			topic: "#.value.add",
			callback: function(newData, envelope) {
				var sensorId = getMatches(envelope.topic, /^.*\.(.*)\.value\.add$/g, 1);
				var deviceId = getMatches(envelope.topic, new RegExp('^(.*)\.' + sensorId + '\.value\.add$', 'g'), 1);		
				var unixTimestamp = Math.round(+new Date()/1000);
				var data = 	getDataForSensor(deviceId, sensorId);			
				data.push([unixTimestamp, newData.x || newData.alpha]);
			}
		});
    </script>

  </body>
<html>   